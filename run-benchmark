#!/bin/bash
set -e; set -u; set -o pipefail
BLUE='\033[0;34m'; RED='\033[0;31m'; GREEN='\033[0;32m'; NC='\033[0m';
ERROR=

VENV=tests/.venv
TESTS=evaluation

if ! diff -q $VENV/requirements.txt $TESTS/requirements.txt; then
    python3 -m venv $VENV
    source $VENV/bin/activate
    python3 -m pip install -r $TESTS/requirements.txt
    cp $TESTS/requirements.txt $VENV/requirements.txt
else
    source $VENV/bin/activate
fi

COMMANDS1=(all ldbc10 pokec telecom ldbc01 icijleak paradise)
COMMANDS2=( both optimized naive)
CMD1=all
CMD2=both
if [[ ${1-} ]]; then
    if [[ " ${COMMANDS1[*]} " =~ " $1" ]]; then
        CMD1=$1
        if [[ " ${COMMANDS2[*]} " =~ " $2" ]]; then
            CMD2=$2
        else
                  echo "Unsupported command: \"$2\", supported commands are: ${COMMANDS2[*]}"
                  exit 1
        fi    
    else
        echo "Unsupported command: \"$1\", supported commands are: ${COMMANDS1[*]}"
        exit 1
    fi
fi

# Configure build and compile
cmake -B build/Release -D CMAKE_BUILD_TYPE=Release
cmake --build build/Release -j 15

python3  $TESTS/script/evaluation.py $CMD1 $CMD2 | tee >(sed $'s/\033[[][^A-Za-z]*m//g' >  $TESTS/test-status-last.txt) || ERROR=true
